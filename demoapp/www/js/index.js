var demoApp = {
    initialize: function () {
        document.addEventListener('deviceready', this.onDeviceReady.bind(this), false);
    },
    onDeviceReady: function () {
        var parentElement = document.getElementById("deviceready");
        var preparingElement = parentElement.querySelector('.preparing');
        var readyElement = parentElement.querySelector('.ready');
        var failedElement = parentElement.querySelector('.failed');
        var button = document.getElementById("smart-protection-button");
        var userIdButton = document.getElementById("set-user-id-button");
        button.setAttribute('style', 'display:inline-block');
        userIdButton.setAttribute('style', 'display:inline-block');
        button.addEventListener("click", this.onRunSmartProtection);
        userIdButton.addEventListener("click", this.onChangeClientId);
        document.getElementById("is-rooted-button").addEventListener("click", function () {
            window.plugins.malwarelytics.rasp.isDeviceRooted(function (result) {
                alert("is rooted: " + result);
            });
        });
        document.getElementById("root-info-button").addEventListener("click", function () {
            window.plugins.malwarelytics.rasp.getRootDetection(function (result) {
                alert(JSON.stringify(result));
            });
        });
        document.getElementById("is-emulator-button").addEventListener("click", function () {
            window.plugins.malwarelytics.rasp.isDeviceEmulator(function (result) {
                alert("is emulator: " + result);
            });
        });
        document.getElementById("emulator-info-button").addEventListener("click", function () {
            window.plugins.malwarelytics.rasp.getEmulatorDetection(function (result) {
                alert(JSON.stringify(result));
            });
        });
        document.getElementById("is-debugger-button").addEventListener("click", function () {
            window.plugins.malwarelytics.rasp.isDebuggerAttached(function (result) {
                alert("is debugger: " + result);
            });
        });
        document.getElementById("debugger-info-button").addEventListener("click", function () {
            window.plugins.malwarelytics.rasp.getDebuggerDetection(function (result) {
                alert(JSON.stringify(result));
            });
        });
        document.getElementById("repackage-info-button").addEventListener("click", function () {
            window.plugins.malwarelytics.rasp.getAppRepackaged(function (result) {
                alert("repackaged: " + result);
            });
        });
        document.getElementById("is-screenshared-button").addEventListener("click", function () {
            window.plugins.malwarelytics.rasp.isScreenShared(function (result) {
                alert("is screenshared: " + result);
            });
        });
        document.getElementById("screenshared-info-button").addEventListener("click", function () {
            window.plugins.malwarelytics.rasp.getScreenSharingDetection(function (result) {
                alert(JSON.stringify(result));
            });
        });
        document.getElementById("is-screenlock-button").addEventListener("click", function () {
            window.plugins.malwarelytics.rasp.isDeviceUsingScreenLock(function (result) {
                alert("is screenlock enabled: " + result);
            });
        });
        document.getElementById("is-playprotect-button").addEventListener("click", function () {
            window.plugins.malwarelytics.rasp.isPlayProtectEnabled(function (result) {
                alert("is play protect enabled: " + result);
            });
        });
        var langSelect = document.getElementById("lang-select");
        langSelect.addEventListener("change", function (e) {
            window.plugins.malwarelytics.changeAppLanguage(e.target.value, function () {
                window.plugins.toast.showShortCenter("Language echanged to " + e.target.value);
            }, function (error) {
                window.plugins.toast.showShortCenter("Failed to change language: " + error.type);
            });
        });
        window.plugins.malwarelytics.isInitialized(function (isInitialized) {
            console.log("Is initialized: " + isInitialized);
        }, function (error) {
            console.log(error);
        });
        window.plugins.malwarelytics.initialize({
            languageCode: "en",
            antivirus: {
                enableSilentMode: false
            },
            rasp: {
                checkDebugger: true
            }
        }, function () {
            preparingElement.setAttribute('style', 'display:none;');
            readyElement.setAttribute('style', 'display:block;');
            console.log("initialized");
            window.plugins.toast.showShortCenter("Malwarelytics initialized");
            window.plugins.malwarelytics.antivirus.getThreatList(function (list) {
                list.items.filter(function (i) { return i.threatIndex == "MALWARE" || i.threatIndex == "HIGHLY_DANGEROUS" || i.threatIndex == "DANGEROUS" || i.threatIndex == "POTENTIALLY_UNWANTED_APP"; }).forEach(function (apk) {
                    var appList = document.getElementById("installed-apps");
                    window.plugins.malwarelytics.antivirus.getApkInfo(apk.packageName, function (apkInfo) {
                        console.log(apkInfo.label);
                        var node = document.createElement('div');
                        var icon = "NO ICON";
                        if (apkInfo.icon) {
                            icon = "<img src=\"data:image/jpeg;base64," + apkInfo.icon + "\" width=\"96\" />";
                        }
                        node.innerHTML = "<h3>" + (apkInfo.label || apk.packageName) + "</h3>" + apk.threatIndex + "<br>" + icon;
                        appList.appendChild(node);
                    });
                });
            });
        }, function (error) {
            preparingElement.setAttribute('style', 'display:none;');
            failedElement.setAttribute('style', 'display:block;');
            console.log(error);
            window.plugins.toast.showShortCenter(error.type);
        });
    },
    onRunSmartProtection: function () {
        window.plugins.toast.showShortCenter("Smart Protection job is in progres...");
        window.plugins.malwarelytics.antivirus.triggerSmartProtection(function () {
            window.plugins.toast.showShortCenter("Smart Protection finished...");
        }, function (error) {
            window.plugins.toast.showShortCenter(error.type);
        });
    },
    onChangeClientId: function () {
        navigator.notification.prompt("Client ID helps you to identify a user within your organization.", function (result) {
            if (result.buttonIndex == 1) {
                window.plugins.malwarelytics.setClientId(result.input1 == "" ? null : result.input1, null, function (error) {
                    window.plugins.toast.showShortCenter(error.type);
                });
            }
        }, "Set Client ID", ["OK", "CLOSE"]);
    }
};
demoApp.initialize();
