/// <reference path="../../plugins/cordova-plugin-malwarelytics/www/MalwarelyticsPlugin.d.ts"/>
/// <reference path="../../plugins/cordova-plugin-device/types/index.d.ts"/>

enum AppState {
    READY,
    PREPARING,
    FAILED
}



var demoApp = {
    
    // Application Constructor
    initialize() {
        document.addEventListener('deviceready', this.onDeviceReady.bind(this), false);
    },

    setButtonClick(id: string, handler: () => void) {
        document.getElementById(id).addEventListener("click", handler);
    },

    setAppState(state: AppState) {

        let parentElement = document.getElementById("deviceready");
        let preparingElement = parentElement.querySelector('.preparing');
        let readyElement = parentElement.querySelector('.ready');
        let failedElement = parentElement.querySelector('.failed');

        switch (state) {
            case AppState.READY:
                readyElement.setAttribute('style', 'display:block;');
                preparingElement.setAttribute('style', 'display:none;');
                failedElement.setAttribute('style', 'display:none;');
                break;
            case AppState.FAILED:
                failedElement.setAttribute('style', 'display:block;');
                preparingElement.setAttribute('style', 'display:none;');
                readyElement.setAttribute('style', 'display:none;');
                break;
            case AppState.PREPARING:
                preparingElement.setAttribute('style', 'display:block;');
                failedElement.setAttribute('style', 'display:none;');
                readyElement.setAttribute('style', 'display:none;');
                break;
        }
    },

    async onDeviceReady() {

        let androidControls = document.getElementById("android-controls");
        androidControls.setAttribute('style', 'display:none;');

        try {
            await window.plugins.malwarelytics.initialize({
                androidConfig: {
                    languageCode: "en",
                    antivirus: {
                        enableSilentMode: false
                    },
                    rasp: {
                        exitOnRoot: true
                    }
                }
            });
        } catch(e) {
            this.setAppState(AppState.FAILED);
            console.error(e);
            return
        }
        
        this.setAppState(AppState.READY);
        console.log("initialized");

        if (device.platform == "Android") {
            androidControls.setAttribute('style', 'display:block;');
            this.configureAndroid();
        }
        
    },

    async configureAndroid() {
        let button = document.getElementById("smart-protection-button");
        let userIdButton = document.getElementById("set-user-id-button");
        button.setAttribute('style', 'display:inline-block');
        userIdButton.setAttribute('style', 'display:inline-block');
        button.addEventListener("click", this.onRunSmartProtection);
        userIdButton.addEventListener("click", this.onChangeClientId);

        this.setButtonClick("is-rooted-button", async () => {
            alert("is rooted: " + await window.plugins.malwarelytics.android.rasp.isDeviceRooted());
        });

        this.setButtonClick("root-info-button", async () => {
            const result = await  window.plugins.malwarelytics.android.rasp.getRootDetection();
            alert(JSON.stringify(result));
        });

        this.setButtonClick("is-emulator-button", async () => {
            alert("is emulator: " + await window.plugins.malwarelytics.android.rasp.isDeviceEmulator());
        });

        this.setButtonClick("emulator-info-button", async () => {
            alert(JSON.stringify(await window.plugins.malwarelytics.android.rasp.getEmulatorDetection()));
        });

        this.setButtonClick("is-debugger-button", async () => {
            alert("is debugger: " + await window.plugins.malwarelytics.android.rasp.isDebuggerAttached());
        });

        this.setButtonClick("debugger-info-button", async () => {
            alert(JSON.stringify(await window.plugins.malwarelytics.android.rasp.getDebuggerDetection()));
        });

        this.setButtonClick("repackage-info-button", async () => {
            alert("repackaged: " + await window.plugins.malwarelytics.android.rasp.getAppRepackaged());
        });

        this.setButtonClick("is-screenshared-button", async () => {
            alert("is screenshared: " + await window.plugins.malwarelytics.android.rasp.isScreenShared());
        });

        this.setButtonClick("screenshared-info-button", async () => {
            alert(JSON.stringify(await window.plugins.malwarelytics.android.rasp.getScreenSharingDetection()));
        });

        this.setButtonClick("is-screenlock-button", async () => {
            alert("is screenlock enabled: " + await window.plugins.malwarelytics.android.rasp.isDeviceUsingScreenLock());
        });

        this.setButtonClick("is-playprotect-button", async () => {
            alert("is play protect enabled: " + await window.plugins.malwarelytics.android.rasp.isPlayProtectEnabled());
        });

        this.setButtonClick("screen-reader-enabled", async () => {
            alert("screen reader enabled: " + await window.plugins.malwarelytics.android.rasp.isNotAllowedScreenReaderEnabled());
        });

        var langSelect = document.getElementById("lang-select");
        langSelect.addEventListener("change", async (e: any) => {
            await window.plugins.malwarelytics.android.changeAppLanguage(e.target.value);
             alert(`Language echanged to ${e.target.value}`);
        });

        const isInitialized = await window.plugins.malwarelytics.isInitialized();
        console.log(`Is initialized: ${isInitialized}`);
        
        try {
            const list = await window.plugins.malwarelytics.android.antivirus.getThreatList();
            list.items.filter(i => i.threatIndex == "MALWARE" || i.threatIndex == "HIGHLY_DANGEROUS" || i.threatIndex == "DANGEROUS" || i.threatIndex == "POTENTIALLY_UNWANTED_APP").forEach( async apk => {
                let appList = document.getElementById("installed-apps");
                let apkInfo = await window.plugins.malwarelytics.android.antivirus.getApkInfo(apk.packageName);
                console.log(apkInfo.label);
                var node = document.createElement('div');
                var icon = "NO ICON";
                if (apkInfo.icon) {
                    icon = `<img src="data:image/jpeg;base64,${apkInfo.icon}" width="96" />`;
                }
                node.innerHTML = `<h3>${apkInfo.label || apk.packageName}</h3>${apk.threatIndex}<br>${icon}`;
                appList.appendChild(node);
            })
        } catch(e) {
            console.log(e);
        }

        let observer: RaspObserver = {
            debuggerDetected(detected: boolean): void {
                console.log("RASP DEBUGGER DETECTED " + detected);
            },
            emulatorDetected(emulatorDetection: EmulatorDetection): void {
                console.log("RASP EMULATOR DETECTED " + JSON.stringify(emulatorDetection));
            },
            repackagingDetected(repackagingResult: RepackagingResult): void {
                console.log("RASP REPACKAGING DETECTED " + JSON.stringify(repackagingResult));
            },
            rootDetected(rootDetection: RootDetection): void {
                console.log("RASP ROOT DETECTED " + JSON.stringify(rootDetection));
            },
            screenSharingDetected(screenSharingDetected: boolean): void {
                console.log("RASP SCREEN SHARING DETECTED " + screenSharingDetected);
            },
            tapjackingDetected(tapjackingDetection: TapjackingDetection): void {
                console.log("RASP TAPJACKING DETECTED " + JSON.stringify(tapjackingDetection));
            }
        }

        window.plugins.malwarelytics.android.rasp.setObserver(observer);
    },

    async onRunSmartProtection() {
        console.log("Smart Protection job is in progres...")
        await window.plugins.malwarelytics.android.antivirus.triggerSmartProtection();
        console.log("Smart Protection finished...")
    },

    onChangeClientId() {
        navigator.notification.prompt("Client ID helps you to identify a user within your organization.", async (result) => {
            if (result.buttonIndex == 1) { // 1 based indexing, lol
                await window.plugins.malwarelytics.setClientId(result.input1 == "" ? null : result.input1 as string);
            }
        }, "Set Client ID", ["OK", "CLOSE"])
    }
};

demoApp.initialize();

// to make typescript happy

declare interface Window {
    plugins: {
        malwarelytics: MalwarelyticsPlugin;
    }
}

declare interface Navigator {
    notification: any;
}